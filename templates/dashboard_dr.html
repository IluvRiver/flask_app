{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="text-center">
        <h1>ğŸŒ Multi-Cloud Dashboard - DR Version</h1>
        <h2>Welcome, {{ current_user.username }}!</h2>
        <div class="dr-status">
            <span class="version-badge">DR Version 2.0</span>
        </div>
    </div>

    <!-- DR Status Section -->
    <div class="dr-info">
        <h3>ğŸ”„ Disaster Recovery Status</h3>
        <div class="status-info">
            <p><strong>í˜„ì¬ ì‹œìŠ¤í…œ:</strong> GCP ê¸°ë³¸, AWS ìë™ ë°±ì—…</p>
            <p><strong>ë³µêµ¬ ëª©í‘œ:</strong> RTO < 30ì´ˆ, RPO < 1ë¶„</p>
            <p><strong>ìƒíƒœ:</strong> <span class="status-active">ğŸŸ¢ ì •ìƒ ìš´ì˜ ì¤‘</span></p>
        </div>
    </div>

<script>
// ì„¸ì…˜ ì •ë³´ë¥¼ Local Storageì— ì €ì¥ (DR ì •ë³´ í¬í•¨)
function updateSessionStorage() {
    fetch('/api/session-info')
        .then(response => response.json())
        .then(data => {
            // Local Storageì— ì„¸ì…˜ ì •ë³´ ì €ì¥
            localStorage.setItem('flask_session_info', JSON.stringify(data));
            localStorage.setItem('flask_session_timestamp', new Date().toISOString());
            
            // DR ìƒíƒœë„ ì €ì¥
            if (data.cloud_provider) {
                localStorage.setItem('dr_status', JSON.stringify({
                    current_provider: data.cloud_provider.current,
                    gcp_available: data.cloud_provider.gcp_available,
                    aws_available: data.cloud_provider.aws_available,
                    timestamp: new Date().toISOString()
                }));
            }
            
            alert('ğŸ”„ Session data & DR status updated!\n\nOpen DevTools > Application > Local Storage to view');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('âŒ Failed to update session data');
        });
}

// Cloud Status í™•ì¸
function checkCloudStatus() {
    fetch('/api/cloud-status')
        .then(response => response.json())
        .then(data => {
            const message = `â˜ï¸ Cloud Provider Status\n\n` +
                           `Current Provider: ${data.current_provider}\n` +
                           `GCP Available: ${data.gcp_available ? 'ğŸŸ¢ Online' : 'ğŸ”´ Offline'}\n` +
                           `AWS Available: ${data.aws_available ? 'ğŸŸ¡ Standby' : 'ğŸ”´ Offline'}\n` +
                           `Last Check: ${new Date(data.last_health_check * 1000).toLocaleString()}`;
            alert(message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('âŒ Failed to check cloud status');
        });
}

// Local Storageì˜ ì„¸ì…˜ ë°ì´í„° ë³´ê¸°
function viewSessionStorage() {
    const sessionInfo = localStorage.getItem('flask_session_info');
    const drStatus = localStorage.getItem('dr_status');
    const timestamp = localStorage.getItem('flask_session_timestamp');
    
    if (sessionInfo) {
        const data = JSON.parse(sessionInfo);
        const dr = drStatus ? JSON.parse(drStatus) : null;
        
        let message = `ğŸ” Session Info (Updated: ${timestamp})\n\n` +
                     `User ID: ${data.user_id}\n` +
                     `Username: ${data.username}\n` +
                     `Session ID: ${data.session_id}\n` +
                     `Authenticated: ${data.is_authenticated}\n` +
                     `Fresh Login: ${data.fresh_login}\n\n`;
        
        if (dr) {
            message += `â˜ï¸ DR Status:\n` +
                      `Current Provider: ${dr.current_provider}\n` +
                      `GCP: ${dr.gcp_available ? 'Online' : 'Offline'}\n` +
                      `AWS: ${dr.aws_available ? 'Online' : 'Offline'}\n\n`;
        }
        
        message += `ğŸ“Š Check DevTools > Application > Local Storage for full data`;
        alert(message);
    } else {
        alert('âš ï¸ No session data found.\nClick "Update Session Storage" first.');
    }
}

// Health Check
function performHealthCheck() {
    fetch('/healthz')
        .then(response => response.json())
        .then(data => {
            const message = `â¤ï¸ Health Check Result\n\n` +
                           `Status: ${data.status}\n` +
                           `Provider: ${data.provider}\n` +
                           `Timestamp: ${new Date(data.timestamp * 1000).toLocaleString()}`;
            alert(message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('âŒ Health check failed');
        });
}

// ìë™ìœ¼ë¡œ ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
updateSessionStorage();

// 5ë¶„ë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
setInterval(updateSessionStorage, 5 * 60 * 1000);

// 2ë¶„ë§ˆë‹¤ í´ë¼ìš°ë“œ ìƒíƒœ ì²´í¬
setInterval(checkCloudStatus, 2 * 60 * 1000);
</script>
    
    <div class="info-grid">
        <div class="info-card">
            <h3>ğŸ“± Client IP</h3>
            <p>{{ client_ip }}</p>
        </div>
        <div class="info-card">
            <h3>ğŸ”„ X-Forwarded-For</h3>
            <p>{{ xff }}</p>
        </div>
        <div class="info-card">
            <h3>ğŸ–¥ï¸ Server Name</h3>
            <p>{{ server_name }}</p>
        </div>
        <div class="info-card">
            <h3>ğŸŒ Server IP</h3>
            <p>{{ server_ip }}</p>
        </div>
    </div>
    
    <div class="text-center mt-20">
        <a href="{{ url_for('board') }}" class="btn btn-primary">ğŸ“ Go to Board</a>
        <button onclick="updateSessionStorage()" class="btn btn-secondary">ğŸ”„ Update Session Storage</button>
        <button onclick="viewSessionStorage()" class="btn btn-secondary">ğŸ” View Session Data</button>
        <button onclick="checkCloudStatus()" class="btn btn-info">â˜ï¸ Cloud Status</button>
        <button onclick="performHealthCheck()" class="btn btn-success">â¤ï¸ Health Check</button>
    </div>
</div>

<style>
.dr-status {
    margin: 10px 0;
}

.version-badge {
    background: #17a2b8;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 14px;
    font-weight: bold;
}

.dr-info {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border-left: 4px solid #007bff;
}

.status-info {
    margin: 10px 0;
}

.status-active {
    color: #28a745;
    font-weight: bold;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
    margin: 2px;
}

.btn-success {
    background-color: #28a745;
    color: white;
    margin: 2px;
}
</style>
{% endblock %}
